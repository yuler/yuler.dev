---
import { getCollection } from 'astro:content'
import LayoutPost from '../../layouts/LayoutPost.astro'
import ChevronRight from '../../components/icons/ChevronRight.astro'
import { formatDate } from '../../utils/date'

export async function getStaticPaths() {
  const blogEntries = await getCollection('posts')
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }))
}

const { entry } = Astro.props
const { Content } = await entry.render()

// Calculate reading time
const readingTime = (content: string) => {
  if (!content) return 1
  const plainText = content
    .replace(/```[\s\S]*?```/g, '')
    .replace(/`[^`]+`/g, '')
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
    .replace(/[#*_~`]/g, '')
    .replace(/\n+/g, ' ')
    .trim()
  const words = plainText.split(/\s+/).filter(word => word.length > 0).length
  return Math.max(1, Math.ceil(words / 200))
}

let readTime = 1
try {
  const contentText = (entry as any).body || ''
  readTime = readingTime(contentText)
} catch {
  readTime = 1
}

---

<LayoutPost frontmatter={entry.data}>
  <!-- Clean Light Background -->
  <div class="min-h-screen bg-[#f5f5f5] text-gray-900">
    <div class="max-w-4xl mx-auto px-4 py-8 md:py-12">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-gray-500 mb-8 font-mono">
        <a href="/" class="hover:text-gray-900 transition-colors">~</a>
        <span class="text-gray-300">/</span>
        <a href="/posts" class="hover:text-gray-900 transition-colors">posts</a>
        <span class="text-gray-300">/</span>
        <span class="text-gray-900 truncate max-w-[200px]">{entry.data.title}</span>
      </nav>

      <!-- Article Header Card -->
      <div class="bg-white border border-gray-200 p-8 mb-8 relative">
        <!-- Corner Markers -->
        <div class="absolute -top-px -left-px w-2 h-2 border-t border-l border-gray-400"></div>
        <div class="absolute -top-px -right-px w-2 h-2 border-t border-r border-gray-400"></div>
        <div class="absolute -bottom-px -left-px w-2 h-2 border-b border-l border-gray-400"></div>
        <div class="absolute -bottom-px -right-px w-2 h-2 border-b border-r border-gray-400"></div>

        {/* Title */}
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 tracking-tight font-mono">
          <span class="text-gray-400">#</span> {entry.data.title}
        </h1>

        {/* Description */}
        {entry.data.description && (
          <p class="text-gray-600 mb-6 text-lg border-l-2 border-gray-300 pl-4">
            <span class="text-gray-400">></span> {entry.data.description}
          </p>
        )}

        {/* Meta Grid */}
        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 pt-4 border-t border-gray-200 font-mono">
          <div class="flex items-center gap-2">
            <span class="text-gray-400">date:</span>
            <time datetime={entry.data.date.toISOString()} class="text-gray-900">
              {entry.data.date.toISOString().split('T')[0]}
            </time>
          </div>
          <span class="text-gray-300">|</span>
          <div class="flex items-center gap-2">
            <span class="text-gray-400">read:</span>
            <span class="text-gray-900">{readTime}min</span>
          </div>
          {entry.data.draft && (
            <>
              <span class="text-gray-300">|</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-gray-200 text-gray-700">DRAFT</span>
            </>
          )}
        </div>

        {/* Tags */}
        {entry.data.tags && entry.data.tags.length > 0 && (
          <div class="flex items-center gap-2 mt-4 pt-4 border-t border-gray-200">
            <span class="text-gray-400 font-mono text-sm">tags:</span>
            {entry.data.tags.map((tag) => (
              <a
                href={`/tags/${tag}`}
                class="px-2 py-0.5 text-sm border border-gray-300 text-gray-600 hover:border-gray-900 hover:text-gray-900 transition-colors"
              >
                {tag}
              </a>
            ))}
          </div>
        )}
      </div>

      <!-- Article Content Card -->
      <div class="bg-white border border-gray-200 p-8 md:p-12 relative">
        <!-- Corner Markers -->
        <div class="absolute -top-px -left-px w-2 h-2 border-t border-l border-gray-400"></div>
        <div class="absolute -top-px -right-px w-2 h-2 border-t border-r border-gray-400"></div>
        <div class="absolute -bottom-px -left-px w-2 h-2 border-b border-l border-gray-400"></div>
        <div class="absolute -bottom-px -right-px w-2 h-2 border-b border-r border-gray-400"></div>
        <article class="prose prose-gray max-w-none
          prose-headings:font-bold prose-headings:text-gray-900 prose-headings:font-mono
          prose-h1:text-3xl prose-h1:md:text-4xl prose-h1:mb-6
          prose-h2:text-xl prose-h2:md:text-2xl prose-h2:mt-8 prose-h2:mb-4 prose-h2:border-b prose-h2:border-gray-200 prose-h2:pb-2
          prose-h3:text-lg prose-h3:md:text-xl prose-h3:mt-6 prose-h3:mb-3
          prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-4
          prose-a:text-gray-900 prose-a:underline prose-a:underline-offset-4 prose-a:decoration-gray-400 prose-a:hover:decoration-gray-900
          prose-strong:text-gray-900 prose-strong:font-semibold
          prose-code:border-gray-300 prose-code:text-rose-600 prose-code:bg-gray-100 prose-code:px-1.5 prose-code:py-0.5 prose-code:text-sm prose-code:before:content-none prose-code:after:content-none
          prose-pre:bg-gray-200 prose-pre:p-4 prose-pre:rounded-none prose-pre:border prose-pre:border-gray-300
          prose-pre:code:text-gray-800 prose-pre:code:bg-transparent prose-pre:code:p-0 prose-pre:code:rounded-none
          prose-ul:my-4 prose-ul:pl-6 prose-ol:my-4 prose-ol:pl-6
          prose-li:my-1 prose-li:text-gray-700
          prose-blockquote:border-l-4 prose-blockquote:border-gray-300 prose-blockquote:bg-gray-50 prose-blockquote:pl-4 prose-blockquote:py-2 prose-blockquote:my-4 prose-blockquote:not-italic prose-blockquote:text-gray-600
          prose-hr:border-gray-200 prose-hr:my-8
          prose-table:w-full prose-table:border-collapse prose-table:my-4
          prose-th:border prose-th:border-gray-200 prose-th:bg-gray-50 prose-th:p-2 prose-th:text-left prose-th:text-gray-900 prose-th:font-semibold prose-th:text-sm prose-th:font-mono
          prose-td:border prose-td:border-gray-200 prose-td:p-2 prose-td:text-gray-700 prose-td:text-sm">
          <Content />
        </article>
      </div>

      <!-- Navigation Footer -->
      <div class="mt-8 flex items-center justify-between bg-white border border-gray-200 p-4 relative">
        <!-- Corner Markers -->
        <div class="absolute -top-px -left-px w-2 h-2 border-t border-l border-gray-400"></div>
        <div class="absolute -top-px -right-px w-2 h-2 border-t border-r border-gray-400"></div>
        <div class="absolute -bottom-px -left-px w-2 h-2 border-b border-l border-gray-400"></div>
        <div class="absolute -bottom-px -right-px w-2 h-2 border-b border-r border-gray-400"></div>

        <a href="/posts" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-gray-900 transition-colors">
          <span>‚Üê</span>
          <span>All posts</span>
        </a>
        <span class="text-xs text-gray-400 font-mono">[END]</span>
      </div>
    </div>
  </div>
</LayoutPost>
