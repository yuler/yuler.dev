---
import { getCollection } from 'astro:content'
import LayoutPost from '../../layouts/LayoutPost.astro'
import BackToHome from '../../components/BackToHome.astro'
import { formatDate, humanize } from '../../utils/date'

export async function getStaticPaths() {
  const blogEntries = await getCollection('posts')
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }))
}

const { entry } = Astro.props
const { Content } = await entry.render()

// Calculate reading time (average reading speed: 200 words per minute)
const readingTime = (content: string) => {
  if (!content) return 1
  // Remove markdown syntax and count words
  const plainText = content
    .replace(/```[\s\S]*?```/g, '') // Remove code blocks
    .replace(/`[^`]+`/g, '') // Remove inline code
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // Remove markdown links but keep text
    .replace(/[#*_~`]/g, '') // Remove markdown formatting
    .replace(/\n+/g, ' ') // Replace newlines with spaces
    .trim()
  
  const words = plainText.split(/\s+/).filter(word => word.length > 0).length
  const minutes = Math.max(1, Math.ceil(words / 200))
  return minutes
}

// Get content text for reading time calculation
// Try to access body from entry, fallback to 1 min if unavailable
let readTime = 1
try {
  const contentText = (entry as any).body || ''
  readTime = readingTime(contentText)
} catch {
  readTime = 1
}
---

<LayoutPost frontmatter={entry.data}>
  <div class="mx-auto max-w-3xl px-4 py-6 md:px-8 md:py-12 lg:py-16">
    <BackToHome />
    
    <!-- Hero Section -->
    <header class="mb-12 border-b border-gray-200 pb-8">
      <h1 class="mb-4 text-4xl font-bold leading-tight tracking-tight text-gray-900 md:text-5xl">
        {entry.data.title}
      </h1>
      
      {entry.data.description && (
        <p class="mb-6 text-xl leading-relaxed text-gray-500 md:text-2xl">
          {entry.data.description}
        </p>
      )}
      
      <div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-wrap items-center gap-2">
          <time 
            class="text-sm font-medium text-gray-500" 
            datetime={entry.data.date.toISOString()}
            title={entry.data.date.toISOString()}
          >
            {formatDate(entry.data.date)}
          </time>
          <span class="text-sm text-gray-300">â€¢</span>
          <span class="text-sm font-medium text-gray-500">{readTime} min read</span>
        </div>
        
        {entry.data.tags && entry.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {entry.data.tags.map((tag) => (
              <a 
                href={`/tags/${tag}`}
                class="inline-flex items-center rounded-lg bg-gray-100 px-3 py-1.5 text-sm font-medium text-gray-700 transition-all duration-200 hover:bg-gray-200 hover:text-gray-900 hover:-translate-y-0.5"
              >
                {tag}
              </a>
            ))}
          </div>
        )}
      </div>
      
      {entry.data.image && (
        <div class="mt-8 overflow-hidden rounded-2xl shadow-lg">
          <img 
            src={entry.data.image.url} 
            alt={entry.data.image.alt}
            class="block h-auto w-full object-cover"
            loading="eager"
          />
        </div>
      )}
    </header>
    
    <!-- Article Content -->
    <article class="prose prose-lg prose-gray max-w-none md:prose-xl 
      prose-headings:font-bold prose-headings:text-gray-900 prose-headings:tracking-tight 
      prose-h2:mt-10 prose-h2:mb-4 prose-h2:text-3xl prose-h2:leading-snug 
      prose-h3:mt-8 prose-h3:mb-3 prose-h3:text-2xl prose-h3:leading-snug 
      prose-h4:mt-6 prose-h4:mb-3 prose-h4:text-xl prose-h4:leading-snug 
      prose-p:mb-6 prose-p:text-gray-700 prose-p:leading-relaxed 
      prose-a:text-blue-600 prose-a:underline prose-a:underline-offset-2 prose-a:transition-colors hover:prose-a:text-blue-700 
      prose-strong:text-gray-900 
      prose-ul:my-6 prose-ul:pl-7 prose-ol:my-6 prose-ol:pl-7 prose-li:my-2 prose-li:text-gray-700 
      prose-blockquote:my-6 prose-blockquote:border-l-4 prose-blockquote:border-blue-500 prose-blockquote:bg-blue-50 prose-blockquote:py-4 prose-blockquote:pl-6 prose-blockquote:pr-6 prose-blockquote:italic prose-blockquote:text-blue-900 prose-blockquote:rounded-r-lg 
      prose-img:my-8 prose-img:rounded-xl prose-img:shadow-lg 
      prose-hr:my-10 prose-hr:border-t prose-hr:border-gray-200 
      prose-table:my-6 prose-table:w-full prose-table:border-collapse 
      prose-th:bg-gray-50 prose-th:p-3 prose-th:text-left prose-th:font-semibold prose-th:text-gray-900 prose-th:border-b prose-th:border-gray-200 
      prose-td:p-3 prose-td:border-b prose-td:border-gray-200">
      <Content />
    </article>
  </div>
</LayoutPost>
